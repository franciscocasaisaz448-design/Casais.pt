-- DARK SCRIPT - Versão Simplificada
print("Carregando script...")

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- Variáveis globais
local panelVisible = false
local prevMouseBehavior, prevMouseIconEnabled
local spectating, savedSubject, savedCamType
local selectedPlayer
local playerButtons = {}
local savedConfigs = {}

-- Sistema de Fly
local FlySystem = {
    flying = false,
    noclip = false,
    speed = 50,
    bodyGyro = nil,
    bodyVelocity = nil,
    control = {F = 0, B = 0, L = 0, R = 0, U = 0, D = 0}
}

function FlySystem:toggleFly()
    self.flying = not self.flying
    local character = LocalPlayer.Character
    if not character then return end
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    if self.flying then
        self.bodyGyro = Instance.new("BodyGyro", hrp)
        self.bodyGyro.MaxTorque = Vector3.new(400000, 400000, 400000)
        self.bodyGyro.D = 1000
        self.bodyGyro.CFrame = hrp.CFrame
        self.bodyVelocity = Instance.new("BodyVelocity", hrp)
        self.bodyVelocity.MaxForce = Vector3.new(400000, 400000, 400000)
        self.bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    else
        if self.bodyGyro then self.bodyGyro:Destroy() end
        if self.bodyVelocity then self.bodyVelocity:Destroy() end
        self.bodyGyro = nil
        self.bodyVelocity = nil
    end
end

function FlySystem:disableFly()
    if self.flying then
        self.flying = false
        if self.bodyGyro then self.bodyGyro:Destroy() end
        if self.bodyVelocity then self.bodyVelocity:Destroy() end
        self.bodyGyro = nil
        self.bodyVelocity = nil
    end
end

function FlySystem:toggleNoclip()
    self.noclip = not self.noclip
end

function FlySystem:setupControls()
    UserInputService.InputBegan:Connect(function(input, gpe)
        if gpe then return end
        if input.KeyCode == Enum.KeyCode.W then self.control.F = 1 end
        if input.KeyCode == Enum.KeyCode.S then self.control.B = 1 end
        if input.KeyCode == Enum.KeyCode.A then self.control.L = 1 end
        if input.KeyCode == Enum.KeyCode.D then self.control.R = 1 end
        if input.KeyCode == Enum.KeyCode.Space then self.control.U = 1 end
        if input.KeyCode == Enum.KeyCode.LeftControl then self.control.D = 1 end
    end)
    UserInputService.InputEnded:Connect(function(input, gpe)
        if gpe then return end
        if input.KeyCode == Enum.KeyCode.W then self.control.F = 0 end
        if input.KeyCode == Enum.KeyCode.S then self.control.B = 0 end
        if input.KeyCode == Enum.KeyCode.A then self.control.L = 0 end
        if input.KeyCode == Enum.KeyCode.D then self.control.R = 0 end
        if input.KeyCode == Enum.KeyCode.Space then self.control.U = 0 end
        if input.KeyCode == Enum.KeyCode.LeftControl then self.control.D = 0 end
    end)
end

function FlySystem:startLoop()
    RunService.RenderStepped:Connect(function()
        local character = LocalPlayer.Character
        if not character then return end
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if not hrp then return end

        if self.noclip then
            for _, v in pairs(character:GetDescendants()) do
                if v:IsA("BasePart") and v.CanCollide == true then
                    v.CanCollide = false
                end
            end
        end

        if self.flying and hrp then
            local cam = workspace.CurrentCamera
            local moveVec = Vector3.zero
            local forward = cam.CFrame.LookVector
            local right = cam.CFrame.RightVector
            local up = Vector3.new(0, 1, 0)
            moveVec = moveVec + forward * (self.control.F - self.control.B) + right * (self.control.R - self.control.L) + up * (self.control.U - self.control.D)
            if moveVec.Magnitude > 0 then
                moveVec = moveVec.Unit * self.speed
                hrp.CFrame = hrp.CFrame + moveVec
            end
        end
    end)
end

function FlySystem:init()
    self:setupControls()
    self:startLoop()
end

-- Funções de jogadores
local function instantTPTo(targetPlayer)
    if not targetPlayer or targetPlayer == LocalPlayer then return end
    local char = LocalPlayer.Character
    local targetChar = targetPlayer.Character
    if not char or not targetChar then return end
    local srcPart = char:FindFirstChild("HumanoidRootPart")
    local dstPart = targetChar:FindFirstChild("HumanoidRootPart")
    if not srcPart or not dstPart then return end
    char:PivotTo(CFrame.new(dstPart.Position + Vector3.new(0,3,0)))
end

local function startSpectate(p)
    if not p or p == LocalPlayer then return end
    local targetChar = p.Character
    if not targetChar then return end
    local hum = targetChar:FindFirstChildOfClass("Humanoid")
    if not hum then return end
    if not savedSubject then savedSubject = Camera.CameraSubject end
    if not savedCamType then savedCamType = Camera.CameraType end
    Camera.CameraType = Enum.CameraType.Custom
    Camera.CameraSubject = hum
    spectating = p
end

local function stopSpectate()
    if savedSubject then Camera.CameraSubject = savedSubject end
    if savedCamType then Camera.CameraType = savedCamType end
    spectating = nil
end

-- GUI
local gui = Instance.new("ScreenGui")
gui.Name = "DarkScript"
gui.ResetOnSpawn = false
pcall(function() gui.Parent = game:GetService("CoreGui") end)
if not gui.Parent then gui.Parent = LocalPlayer:WaitForChild("PlayerGui") end

-- Frame principal
local frame = Instance.new("Frame")
frame.Size = UDim2.fromOffset(700, 500)
frame.Position = UDim2.new(0.5, -350, 0.5, -250)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
frame.Visible = false
frame.Parent = gui
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 10)

-- Header
local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 50)
header.BackgroundColor3 = Color3.fromRGB(139, 92, 246)
header.Parent = frame
Instance.new("UICorner", header).CornerRadius = UDim.new(0, 10)

local headerCover = Instance.new("Frame")
headerCover.Size = UDim2.new(1, 0, 0, 20)
headerCover.Position = UDim2.new(0, 0, 1, -20)
headerCover.BackgroundColor3 = Color3.fromRGB(139, 92, 246)
headerCover.BorderSizePixel = 0
headerCover.Parent = header

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -100, 1, 0)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextSize = 20
title.TextColor3 = Color3.new(1,1,1)
title.TextXAlignment = Enum.TextXAlignment.Left
title.Text = "DARK SCRIPT"
title.Parent = header

local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.fromOffset(40, 40)
closeBtn.Position = UDim2.new(1, -45, 0, 5)
closeBtn.Text = "X"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 18
closeBtn.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
closeBtn.TextColor3 = Color3.fromRGB(255,255,255)
closeBtn.Parent = header
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 8)

-- Tabs
local tabs = Instance.new("Frame")
tabs.Size = UDim2.new(0, 120, 1, -60)
tabs.Position = UDim2.new(0, 10, 0, 55)
tabs.BackgroundTransparency = 1
tabs.Parent = frame

local function makeTab(text, order)
    local b = Instance.new("TextButton")
    b.Size = UDim2.new(1, 0, 0, 40)
    b.Position = UDim2.new(0, 0, 0, (order-1) * 45)
    b.Text = text
    b.Font = Enum.Font.GothamBold
    b.TextSize = 12
    b.BackgroundColor3 = Color3.fromRGB(35,35,45)
    b.TextColor3 = Color3.fromRGB(180,180,190)
    b.Parent = tabs
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 8)
    return b
end

local tabPlayers = makeTab("JOGADORES", 1)
local tabMovement = makeTab("MOVIMENTO", 2)
local tabMisc = makeTab("MISC", 3)

-- Pages
local pages = Instance.new("Frame")
pages.Size = UDim2.new(1, -145, 1, -60)
pages.Position = UDim2.new(0, 135, 0, 55)
pages.BackgroundTransparency = 1
pages.Parent = frame

local function makePage()
    local p = Instance.new("ScrollingFrame")
    p.Size = UDim2.fromScale(1,1)
    p.BackgroundTransparency = 1
    p.BorderSizePixel = 0
    p.ScrollBarThickness = 4
    p.CanvasSize = UDim2.new(0,0,0,0)
    p.AutomaticCanvasSize = Enum.AutomaticSize.Y
    p.Visible = false
    p.Parent = pages
    local layout = Instance.new("UIListLayout", p)
    layout.Padding = UDim.new(0,8)
    return p, layout
end

local playersPage, playersLayout = makePage()
local movementPage, movementLayout = makePage()
local miscPage, miscLayout = makePage()

playersPage.Visible = true

-- Players Page
local playersList = Instance.new("ScrollingFrame")
playersList.Size = UDim2.new(1, 0, 0, 300)
playersList.BackgroundColor3 = Color3.fromRGB(35,35,45)
playersList.BorderSizePixel = 0
playersList.ScrollBarThickness = 4
playersList.CanvasSize = UDim2.new(0,0,0,0)
playersList.AutomaticCanvasSize = Enum.AutomaticSize.Y
playersList.Parent = playersPage
Instance.new("UICorner", playersList).CornerRadius = UDim.new(0, 8)
local playersListLayout = Instance.new("UIListLayout", playersList)
playersListLayout.Padding = UDim.new(0,4)

local selectedPlayerTitle = Instance.new("TextLabel")
selectedPlayerTitle.Size = UDim2.new(1, 0, 0, 30)
selectedPlayerTitle.BackgroundColor3 = Color3.fromRGB(35,35,45)
selectedPlayerTitle.Font = Enum.Font.GothamBold
selectedPlayerTitle.TextSize = 14
selectedPlayerTitle.TextColor3 = Color3.fromRGB(255,255,255)
selectedPlayerTitle.Text = "SELECIONE UM JOGADOR"
selectedPlayerTitle.Parent = playersPage
Instance.new("UICorner", selectedPlayerTitle).CornerRadius = UDim.new(0, 8)

local function createActionButton(text, callback)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, 0, 0, 40)
    btn.Text = text
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 13
    btn.BackgroundColor3 = Color3.fromRGB(139, 92, 246)
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.Parent = playersPage
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)
    btn.MouseButton1Click:Connect(function()
        if selectedPlayer then callback(selectedPlayer) end
    end)
    return btn
end

createActionButton("TELEPORTAR", instantTPTo)
createActionButton("ESPECTAR", startSpectate)
createActionButton("PARAR ESPECTAR", stopSpectate)

local function createPlayerButton(player)
    if not player or player == LocalPlayer then return end
    local btn = Instance.new("TextButton")
    btn.Name = player.Name
    btn.Size = UDim2.new(1, -8, 0, 40)
    btn.BackgroundColor3 = Color3.fromRGB(45,45,55)
    btn.Text = player.Name
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 13
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.Parent = playersList
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    
    btn.MouseButton1Click:Connect(function()
        for _, button in pairs(playerButtons) do
            if button:IsA("TextButton") then
                button.BackgroundColor3 = Color3.fromRGB(45,45,55)
            end
        end
        btn.BackgroundColor3 = Color3.fromRGB(139, 92, 246)
        selectedPlayer = player
        selectedPlayerTitle.Text = "SELECIONADO: " .. player.Name
    end)
    
    playerButtons[player] = btn
end

-- Movement Page
local flyToggle = Instance.new("TextButton")
flyToggle.Size = UDim2.new(1, 0, 0, 50)
flyToggle.Text = "FLY: OFF"
flyToggle.Font = Enum.Font.GothamBold
flyToggle.TextSize = 16
flyToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
flyToggle.TextColor3 = Color3.fromRGB(255,255,255)
flyToggle.Parent = movementPage
Instance.new("UICorner", flyToggle).CornerRadius = UDim.new(0, 8)
flyToggle.MouseButton1Click:Connect(function()
    FlySystem:toggleFly()
    flyToggle.Text = FlySystem.flying and "FLY: ON" or "FLY: OFF"
    flyToggle.BackgroundColor3 = FlySystem.flying and Color3.fromRGB(0, 160, 90) or Color3.fromRGB(60, 60, 70)
end)

local noclipToggle = Instance.new("TextButton")
noclipToggle.Size = UDim2.new(1, 0, 0, 50)
noclipToggle.Text = "NOCLIP: OFF"
noclipToggle.Font = Enum.Font.GothamBold
noclipToggle.TextSize = 16
noclipToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
noclipToggle.TextColor3 = Color3.fromRGB(255,255,255)
noclipToggle.Parent = movementPage
Instance.new("UICorner", noclipToggle).CornerRadius = UDim.new(0, 8)
noclipToggle.MouseButton1Click:Connect(function()
    FlySystem:toggleNoclip()
    noclipToggle.Text = FlySystem.noclip and "NOCLIP: ON" or "NOCLIP: OFF"
    noclipToggle.BackgroundColor3 = FlySystem.noclip and Color3.fromRGB(0, 160, 90) or Color3.fromRGB(60, 60, 70)
end)

-- Misc Page
local infoLabel = Instance.new("TextLabel")
infoLabel.Size = UDim2.new(1, 0, 0, 100)
infoLabel.BackgroundColor3 = Color3.fromRGB(35,35,45)
infoLabel.Font = Enum.Font.Gotham
infoLabel.TextSize = 12
infoLabel.TextColor3 = Color3.fromRGB(200,200,200)
infoLabel.TextWrapped = true
infoLabel.Text = "CONTROLES:\n\nM: Abrir/Fechar menu\nF: Toggle Fly\nWASD: Movimento\nSpace: Subir\nCtrl: Descer"
infoLabel.Parent = miscPage
Instance.new("UICorner", infoLabel).CornerRadius = UDim.new(0, 8)

-- Funções
local function updatePlayersList()
    for _, child in ipairs(playersList:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end
    playerButtons = {}
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            createPlayerButton(player)
        end
    end
end

local function setTab(which)
    tabPlayers.BackgroundColor3 = Color3.fromRGB(35,35,45)
    tabPlayers.TextColor3 = Color3.fromRGB(180,180,190)
    tabMovement.BackgroundColor3 = Color3.fromRGB(35,35,45)
    tabMovement.TextColor3 = Color3.fromRGB(180,180,190)
    tabMisc.BackgroundColor3 = Color3.fromRGB(35,35,45)
    tabMisc.TextColor3 = Color3.fromRGB(180,180,190)
    playersPage.Visible = false
    movementPage.Visible = false
    miscPage.Visible = false
    
    if which == "PLAYERS" then
        tabPlayers.BackgroundColor3 = Color3.fromRGB(139, 92, 246)
        tabPlayers.TextColor3 = Color3.fromRGB(255,255,255)
        playersPage.Visible = true
    elseif which == "MOVEMENT" then
        tabMovement.BackgroundColor3 = Color3.fromRGB(139, 92, 246)
        tabMovement.TextColor3 = Color3.fromRGB(255,255,255)
        movementPage.Visible = true
    else
        tabMisc.BackgroundColor3 = Color3.fromRGB(139, 92, 246)
        tabMisc.TextColor3 = Color3.fromRGB(255,255,255)
        miscPage.Visible = true
    end
end

local function showPanel(show)
    if panelVisible == show then return end
    panelVisible = show
    frame.Visible = show
    if show then
        prevMouseBehavior = UserInputService.MouseBehavior
        prevMouseIconEnabled = UserInputService.MouseIconEnabled
        UserInputService.MouseBehavior = Enum.MouseBehavior.Default
        UserInputService.MouseIconEnabled = true
        updatePlayersList()
    else
        if prevMouseBehavior then UserInputService.MouseBehavior = prevMouseBehavior end
        if prevMouseIconEnabled ~= nil then UserInputService.MouseIconEnabled = prevMouseIconEnabled end
    end
end

-- Eventos
tabPlayers.MouseButton1Click:Connect(function() setTab("PLAYERS") end)
tabMovement.MouseButton1Click:Connect(function() setTab("MOVEMENT") end)
tabMisc.MouseButton1Click:Connect(function() setTab("MISC") end)

closeBtn.MouseButton1Click:Connect(function()
    frame.Visible = false
    panelVisible = false
    if prevMouseBehavior then UserInputService.MouseBehavior = prevMouseBehavior end
    if prevMouseIconEnabled ~= nil then UserInputService.MouseIconEnabled = prevMouseIconEnabled end
end)

UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    if input.KeyCode == Enum.KeyCode.M then
        showPanel(not panelVisible)
    elseif input.KeyCode == Enum.KeyCode.F then
        FlySystem:toggleFly()
        flyToggle.Text = FlySystem.flying and "FLY: ON" or "FLY: OFF"
        flyToggle.BackgroundColor3 = FlySystem.flying and Color3.fromRGB(0, 160, 90) or Color3.fromRGB(60, 60, 70)
    end
end)

Players.PlayerAdded:Connect(function(p) wait(0.5); updatePlayersList() end)
Players.PlayerRemoving:Connect(function(p)
    if playerButtons[p] then playerButtons[p]:Destroy(); playerButtons[p] = nil end
    if selectedPlayer == p then selectedPlayer = nil; selectedPlayerTitle.Text = "SELECIONE UM JOGADOR" end
    if spectating == p then stopSpectate() end
end)

LocalPlayer.CharacterAdded:Connect(function(char)
    local hum = char:WaitForChild("Humanoid")
    hum.Died:Connect(function()
        FlySystem:disableFly()
        if flyToggle then
            flyToggle.Text = "FLY: OFF"
            flyToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
        end
    end)
end)

-- Inicialização
FlySystem:init()
updatePlayersList()
setTab("PLAYERS")
showPanel(true)
print("Script carregado! Pressione M para abrir/fechar")
